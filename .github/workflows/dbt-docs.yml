name: dbt Docs (DEV) Publish

on:
  workflow_dispatch:

jobs:
  build_and_publish_docs:
    name: Build and publish dbt docs (DEV)
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    defaults:
      run:
        working-directory: dbt_pipeline
    env:
      DBT_PROFILES_DIR: ${{ github.workspace }}/dbt_pipeline
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DEV_DATABASE: ${{ secrets.SNOWFLAKE_DEV_DATABASE }}
      SNOWFLAKE_DEV_SCHEMA: ${{ secrets.SNOWFLAKE_DEV_SCHEMA }}
      SNOWFLAKE_DEV_ROLE: ${{ secrets.SNOWFLAKE_DEV_ROLE }}
      SNOWFLAKE_PRIVATE_KEY_PASSPHRASE: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSPHRASE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt (Snowflake)
        run: |
          pip install dbt-snowflake

      - name: Write Snowflake private key (DEV)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/dbt_svc_rsa_key.p8
          chmod 600 ~/.ssh/dbt_svc_rsa_key.p8
          echo "SNOWFLAKE_PRIVATE_KEY_PATH=$HOME/.ssh/dbt_svc_rsa_key.p8" >> $GITHUB_ENV

      - name: dbt deps
        run: dbt deps

      - name: dbt docs generate (DEV)
        run: dbt docs generate --target dev

      - name: Sync docs to docs/dbt_docs
        working-directory: ${{ github.workspace }}
        run: |
          rm -rf docs/dbt_docs/*
          cp -R dbt_pipeline/target/* docs/dbt_docs/

      - name: Commit and push docs changes
        working-directory: ${{ github.workspace }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet docs/dbt_docs; then
            echo "No doc changes to commit."
          else
            git add docs/dbt_docs
            git commit -m "CI: Refresh dbt docs (dev)"
            git push
          fi
